name: Build and Deploy to Netlify
on:
  # push:
  pull_request:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      # Cache node modules and next folder
      - name: üì¨ Caching
        uses: actions/cache@v2
        with:
          path: |
            **/node_modules
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn-lock.json') }}

      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 16.x

      - name: üß∞ Install dependencies
        run: yarn

      - name: üì¶ Build project
        env:
          CMS_API_ENDPOINT: ${{ secrets.CMS_API_ENDPOINT }}
          CMS_API_USERNAME: ${{ secrets.CMS_API_USERNAME }}
          CMS_API_PASSWORD: ${{ secrets.CMS_API_PASSWORD }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          NEXT_PUBLIC_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_ANALYTICS_ID }}
        run: npx vercel build
      # if: "!contains(github.event.head_commit.message, '[skip ci]')"
      # steps:
      #   - name: Checkout
      #     uses: actions/checkout@v2
      - name: Deploy to Vercel Action
        id: vercel-deploy
        uses: zhex900/deploy-to-vercel-action@latest
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          # PRODUCTION: false
          # GITHUB_DEPLOYMENT_ENV: "Preview"
          CREATE_COMMENT: true
      # - uses: amondnet/vercel-action@v20 #deploy
      #   with:
      #     vercel-token: ${{ secrets.VERCEL_TOKEN }} # Required
      #     github-token: ${{ secrets.GITHUB_TOKEN }} #Optional
      #     vercel-args: "--prebuilt" #"--prod" #Optional
      #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID}} #Required
      #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID}} #Required
      # - uses: phulsechinmay/rewritable-pr-comment@v0.3.0
      #   if: ${{ steps.vercel-deploy.outputs.DEPLOYMENT_CREATED }}
      #   with:
      #     message: |
      #       This pull request has been deployed to Vercel.

      #       <table>
      #         <tr>
      #           <td><strong>‚úÖ Preview:</strong></td>
      #           <td><a href='${{ steps.vercel-deploy.outputs.PREVIEW_URL }}'>${{ steps.vercel-deploy.outputs.PREVIEW_URL }}</a></td>
      #         </tr>
      #       </table>

      #       [View Workflow Logs](${ LOG_URL })
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     COMMENT_IDENTIFIER: "vercel-deploy"
      # - name: üßπ Run lint
      #   run: npm run lint

      # - name: üêõ Run tests
      #   run: npm run test

      # Deploy to Netlify with a personalized message
      # - name: üöÄ Deploy to Vercel
      #   run: npx vercel deploy --prebuilt -t ${{ secrets.VERCEL_TOKEN }}

      # - name: Set env variables
      #   run: |
      #     export CMS_API_ENDPOINT=${{ secrets.CMS_API_ENDPOINT }}
      #     export CMS_API_USERNAME=${{ secrets.CMS_API_USERNAME }}
      #     export CMS_API_PASSWORD=${{ secrets.CMS_API_PASSWORD }}
      #     export SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
      #     export NEXT_PUBLIC_ANALYTICS_ID=${{ secrets.NEXT_PUBLIC_ANALYTICS_ID }}
      # - name: Build Nextjs Site
      #   run: |
      #     export CMS_API_ENDPOINT=${{ secrets.CMS_API_ENDPOINT }}
      #     export CMS_API_USERNAME=${{ secrets.CMS_API_USERNAME }}
      #     export CMS_API_PASSWORD=${{ secrets.CMS_API_PASSWORD }}
      #     export SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
      #     export NEXT_PUBLIC_ANALYTICS_ID=${{ secrets.NEXT_PUBLIC_ANALYTICS_ID }}
      #     yarn build
      #     cp -r .next build
      #     ls build
      # - name: Deploy
      #   uses: jsmrcaga/action-netlify-deploy@master
      #   # run: |
      #   #   export CMS_API_ENDPOINT=${{ secrets.CMS_API_ENDPOINT }}
      #   #   export CMS_API_USERNAME=${{ secrets.CMS_API_USERNAME }}
      #   #   export CMS_API_PASSWORD=${{ secrets.CMS_API_PASSWORD }}
      #   #   export SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
      #   #   export NEXT_PUBLIC_ANALYTICS_ID=${{ secrets.NEXT_PUBLIC_ANALYTICS_ID }}
      #   with:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      #     deploy_alias: ${{ env.BRANCH_NAME }}
      #     build_directory: ".next"
      #   env:
      #     CMS_API_ENDPOINT: ${{ secrets.CMS_API_ENDPOINT }}
      #     CMS_API_USERNAME: ${{ secrets.CMS_API_USERNAME }}
      #     CMS_API_PASSWORD: ${{ secrets.CMS_API_PASSWORD }}
      #     SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      #     NEXT_PUBLIC_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_ANALYTICS_ID }}
      # # Creates a status check with link to preview
      # - name: Status check
      #   uses: Sibz/github-status-action@v1.1.1
      #   with:
      #     authToken: ${{ secrets.GITHUB_TOKEN }}
      #     context: Netlify preview
      #     state: success
      #     target_url: https://${{ env.BRANCH_NAME }}.netlify.app
      # env:
      #   CMS_API_ENDPOINT: ${{ secrets.CMS_API_ENDPOINT }}
      #   CMS_API_USERNAME: ${{ secrets.CMS_API_USERNAME }}
      #   CMS_API_PASSWORD: ${{ secrets.CMS_API_PASSWORD }}
      #   SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      #   NEXT_PUBLIC_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_ANALYTICS_ID }}
