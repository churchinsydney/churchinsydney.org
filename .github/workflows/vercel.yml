name: Build and Deploy to Vercel
on:
  workflow_dispatch:
    inputs:
      publishId:
        description: CMS publish id
        required: true
  push:
    branches:
      - "master"
  pull_request:
  release:
    types: [published]

jobs:
  push-run-id-to-cms:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Push run id to CMS
        run: |
          echo "CMS publish id: ${{ github.event.inputs.publishId }}"

          CMS_TOKEN="$(curl --request POST \
            --url "${{ secrets.CMS_API_ENDPOINT}}/auth/login" \
            --header 'Content-Type: application/json' \
            --data '{
              "email": "${{ secrets.CMS_API_PUBLISH }}",
              "password": "${{ secrets.CMS_API_PUBLISH_PASSWORD }}"
            }' | jq -r '.data.access_token')" 
          echo $CMS_TOKEN
          echo "CMS_TOKEN=$CMS_TOKEN" >> $GITHUB_ENV
          curl --request PATCH \
            --url "${{ secrets.CMS_API_ENDPOINT}}/items/publish/${{ github.event.inputs.publishId }}" \
            --header "Authorization: Bearer $CMS_TOKEN" \
            --header 'Content-Type: application/json' \
            --data '{
              "run_id": "${{ github.run_id }}",
              "status": "deploying"
            }'

  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest release with tag
        id: latest-release
        run: |
          echo "LATEST_RELEASE_TAG=$(curl -s ${{ github.api_url }}/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')" >> $GITHUB_ENV

      - name: Configure environment
        run: |
          echo "Trigger by event: ${{ github.event_name }}"
          echo "Latest release tag: ${{ env.LATEST_RELEASE_TAG }}"
          echo "Git ref: ${{ github.ref_name }}"

          RELEASE=${{ github.event.release.tag_name }}
          if [[ "$RELEASE" != "" || ${{ github.event_name }} == 'workflow_dispatch' ]]; then
            echo "Production deployment"
            echo "PROD_BUILD=--prod" >> $GITHUB_ENV
          else
            echo "Preview deployment"
            echo "PROD_BUILD=" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@v3

      - name: Checkout latest release
        run: |
          if [[ ${{ github.event_name }} == 'workflow_dispatch' ]]; then
            git fetch --unshallow --tags
            git checkout tags/${{ env.LATEST_RELEASE_TAG }} -B latest-release-${{ env.LATEST_RELEASE_TAG }}
          else
            git checkout ${{ github.ref_name }}
          fi
          git symbolic-ref HEAD
          ls

      - name: ðŸ“¬ Caching
        uses: actions/cache@v2
        with:
          path: |
            **/node_modules
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn-lock.json') }}

      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 16.x

      - name: ðŸ§° Install dependencies
        run: yarn

      - name: ðŸ“¦ Build project
        env:
          CMS_API_ENDPOINT: ${{ secrets.CMS_API_ENDPOINT }}
          CMS_API_USERNAME: ${{ secrets.CMS_API_USERNAME }}
          CMS_API_PASSWORD: ${{ secrets.CMS_API_PASSWORD }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          NEXT_PUBLIC_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_ANALYTICS_ID }}
        run: npx vercel build ${{ env.PROD_BUILD }}

      - name: Deploy to Vercel Action
        id: vercel-deploy
        uses: zhex900/deploy-to-vercel-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ARGS: "--prebuilt"
          CREATE_COMMENT: true
          PRODUCTION: ${{ env.PROD_BUILD != '' }}

      - name: Save deployed url
        run: |
          mkdir -p ./pr
          echo ${{steps.vercel-deploy.outputs.PREVIEW_URL}} > ./pr/pr_deployed_url
      - uses: actions/upload-artifact@v2
        with:
          name: pr_deployed_url
          path: pr/

  notify-cms:
    runs-on: ubuntu-latest
    needs:
      - deploy
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Push status to CMS
        run: |
          curl --request PATCH \
            --url "${{ secrets.CMS_API_ENDPOINT}}/items/publish/${{ github.event.inputs.publishId }}" \
            --header "Authorization: Bearer ${{ env.CMS_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data '{
              "status": ${{ github.event.workflow_run.conclusion }}
            }'
